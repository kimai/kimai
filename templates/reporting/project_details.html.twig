{% extends 'reporting/layout.html.twig' %}
{% import "macros/charts.html.twig" as charts %}
{% import "macros/widgets.html.twig" as widgets %}

{% set tableName = tableName|default('project_details_reporting') %}
{% set tableId = 'project-details-form' %}
{% set showMoneyBudget = project_details is not null and is_granted('budget', project_details.project) %}
{% set showTimeBudget = project_details is not null and is_granted('time', project_details.project) %}
{% set view_revenue = project_details is not null and is_granted('view_rate_other_timesheet') %}
{% set see_users = is_granted('view_other_timesheet') or is_granted('view_other_reporting') %}

{% block stylesheets %}
    {{ parent() }}
    {{ encore_entry_link_tags('chart') }}
{% endblock %}

{% block head %}
    {{ parent() }}
    {{ encore_entry_script_tags('chart') }}
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {% set options = {'label': 'duration', 'title': 'name', 'legend': {'display': false}} %}
    {% if view_revenue %}
        {% set options = options|merge({'footer': 'rate'}) %}
    {% endif %}
    {{ charts.doughnut_javascript(options) }}
    {{ charts.bar_javascript({'legend': {'display': false}}) }}
    <script type="text/javascript">
        document.getElementById('report-form').addEventListener('change', function(event) {
            event.currentTarget.submit();
        });

        const triggerTabList = [].slice.call(document.querySelectorAll('a[data-bs-toggle="tab"]'))
        triggerTabList.forEach(function (triggerEl) {
            triggerEl.addEventListener('shown.bs.tab', function (event) {
                renderChart(event.target.dataset.chart);
                //event.preventDefault()
            })
        })

        function renderChart(chartName)
        {
            let found = false;

            for (const instance of Object.values(Chart.instances)) {
                if (instance.canvas.id === chartName) {
                    found = true;
                }
            }

            if (!found) {
                document.dispatchEvent(new Event('render.' + chartName))
            }
        }
    </script>
{% endblock %}

{% block report_form %}
    {% form_theme form '@theme/layout/form-theme-horizontal.html.twig' %}
    {{ form_start(form, {'attr': {'id': 'report-form'}}) }}
    {{ form_row(form.project, {'placeholder': 'please_choose', 'row_attr': {'class': 'w-100'}}) }}
    {{ form_end(form) }}
{% endblock %}

{% block report %}
    {% set hasData = project is not null and project_view is not null %}

    {% if not hasData %}
        {{ widgets.nothing_found() }}
    {% else %}
        {{ _self.project_details(project, project_view, project_details, showMoneyBudget, showTimeBudget, view_revenue, see_users) }}
        {% set currency = project.customer.currency %}

        {%- for yearStat in project_details.years|reverse %}
            {% set year = yearStat.year %}
            {{ _self.duration_stat(year, year, year, month_names(), yearStat, project_details.getYearActivities(year), project_details.userYears(year), currency, view_revenue, see_users) }}
        {% endfor %}
    {% endif %}
{% endblock %}

{% macro duration_stat(id, title, year, labels, yearStat, activities, users, currency, view_revenue, see_users) %}
    {% set rates = [] %}
    {% set durations = [] %}
    {% set chartPrefix = 'chart' ~ id %}
    {% for monthNumber in 1..12 %}
        {% set rate = 0 %}
        {% set duration = 0 %}
        {% set month = yearStat.month(monthNumber) %}
        {% if month is not null %}
            {% set rate = month.totalRate %}
            {% set duration = month.totalDuration %}
        {% endif %}
        {% set durations = durations|merge([{'label': duration|duration, 'value': duration|chart_duration}]) %}
        {% set rates = rates|merge([{'label': rate|money(currency), 'value': rate}]) %}
    {% endfor -%}

    <div class="card mb-3">
        <div class="card-header">
            <h3 class="card-title">
                {{ title }}
            </h3>
            <div class="card-actions">
                {{ widgets.badge_counter(yearStat.duration|duration) }}
                {% if view_revenue %}
                    {{ widgets.badge_counter(yearStat.rate|money(currency)) }}
                {% endif %}
            </div>
        </div>
        <ul class="nav nav-tabs" data-bs-toggle="tabs">
            <li class="nav-item"><a class="nav-link active" data-chart="{{ chartPrefix }}Duration" href="#time-chart-{{ id }}" data-bs-toggle="tab">{{ 'stats.workingTime'|trans }}</a></li>
            {% if view_revenue %}
                <li class="nav-item"><a class="nav-link" data-chart="{{ chartPrefix }}Rate" href="#revenue-chart-{{ id }}" data-bs-toggle="tab">{{ 'stats.revenue'|trans }}</a></li>
            {% endif %}
            {% if see_users %}
            <li class="nav-item"><a class="nav-link" data-chart="{{ chartPrefix }}User" href="#user-chart-{{ id}}" data-bs-toggle="tab">{{ 'label.user'|trans }}</a></li>
            {% endif %}
            <li class="nav-item"><a class="nav-link" data-chart="{{ chartPrefix }}Activity" href="#activity-chart-{{ id}}" data-bs-toggle="tab">{{ 'label.activity'|trans }}</a></li>
        </ul>
        <div class="tab-content mt-2 p-2">
            <div class="chart tab-pane active" id="time-chart-{{ id }}">
                <div class="row">
                    <div class="col-xs-12">
                        {{ charts.bar_chart(chartPrefix ~ 'Duration', labels, [durations], {'height': '300px'}) }}
                    </div>
                </div>
            </div>
            {% if view_revenue %}
                <div class="chart tab-pane" id="revenue-chart-{{ id }}">
                    <div class="row">
                        <div class="col-xs-12">
                            {{ charts.bar_chart(chartPrefix ~ 'Rate', labels, [rates], {'height': '300px', 'renderEvent': 'render.' ~ chartPrefix ~ 'Rate'}) }}
                        </div>
                    </div>
                </div>
            {% endif %}
            <div class="chart tab-pane" id="activity-chart-{{ id }}">
                {{ _self.activity_tab(activities, yearStat.duration, currency, chartPrefix, view_revenue) }}
            </div>
            {% if see_users %}
            <div class="chart tab-pane" id="user-chart-{{ id }}">
                {{ _self.user_tab(year, users) }}
            </div>
            {% endif %}
        </div>
    </div>
{% endmacro %}

{% macro user_tab(year, userYearStats) %}
    <div class="row">
        <div class="col-xs-12 table-responsive">
            <table class="table table-hover dataTable">
                <tr>
                    <th>{{ 'label.username'|trans }}</th>
                    <th></th>
                    {% for monthName in month_names() %}
                        <th class="text-center">{{ monthName }}</th>
                    {% endfor %}
                </tr>
                {% set yearTotal = 0 %}
                {% for userYearStat in userYearStats|sort((a, b) => b.duration <=> a.duration) %}
                    {% set user = userYearStat.user %}
                    {% set userYear = userYearStat.year %}
                    {% set userTotal = userYearStat.duration %}
                    {% set yearTotal = yearTotal + userTotal %}
                    <tr>
                        <td class="text-nowrap">
                            {{ widgets.label_dot(user.displayName, user.color) }}
                        </td>
                        <th class="text-nowrap text-center total">
                            {{ userTotal|duration }}
                        </th>
                        {% for monthNumber in 1..12 %}
                            {% set month = userYear.getMonth(monthNumber) %}
                            <td class="text-nowrap text-center">
                                {% if month is not null %}
                                    {{ month.totalDuration|duration }}
                                {% endif %}
                            </td>
                        {% endfor %}
                    </tr>
                {% endfor %}
                <tr>
                    <th></th>
                    <th class="text-nowrap text-center total">
                        {{ yearTotal|duration }}
                    </th>
                    {% for monthNumber in 1..12 %}
                        {% set total = 0 %}
                        {% for userYearStat in userYearStats %}
                            {% set month = userYearStat.year.getMonth(monthNumber) %}
                            {% if month is not null %}
                                {% set total = total + month.duration %}
                            {% endif %}
                        {% endfor %}
                        <th class="text-nowrap text-center total">
                        {{ total|duration }}
                        </th>
                    {% endfor %}
                </tr>
            </table>
        </div>
    </div>
{% endmacro %}

{#
    activities       = array<ActivityStatistic>
    totalDuration    = int
    currency         = string
    chartPrefix      = string
    view_revenue     = boolean
#}
{% macro activity_tab(activities, totalDuration, currency, chartPrefix, view_revenue) %}
    {% set dataset = [] %}
    {% set labels = [] %}
    <div class="row">
        <div class="col-xs-12 col-sm-9 col-md-8 col-lg-6">
            <table class="table table-hover dataTable">
                {% for stat in activities|sort((a, b) => b.duration <=> a.duration) %}
                    {% set dataset = dataset|merge([{'value': stat.duration, 'name': stat.name, 'color': stat.activity.color|colorize(stat.activity.name), 'duration': stat.duration|duration, 'rate': stat.rate|money(currency)}]) %}
                    {% set percentage = 0 %}
                    {% if totalDuration > 0 and stat.duration > 0 %}
                        {% set percentage = (100 / (totalDuration / stat.duration)) %}
                    {% endif %}
                    <tr>
                        <td>{{ widgets.label_activity(stat.activity, {'inherit': false, 'random': true}) }}</td>
                        <td class="text-nowrap text-end">{{ stat.duration|duration }}</td>
                        {% if view_revenue %}
                        <td class="text-nowrap text-end">{{ stat.rate|money(currency) }}</td>
                        {% endif %}
                        <td class="text-nowrap text-end">{{ percentage|number_format(1) }} %</td>
                    </tr>
                {% endfor %}
            </table>
        </div>
        <div class="col-xs-12 col-sm-3 col-md-4 col-lg-6">
            {% set chartOptions = {'height': (dataset|length > 12 ? '600px' : '300px'), 'renderEvent': 'render.' ~ chartPrefix ~ 'Activity'} %}
            {{ charts.doughnut_chart(chartPrefix ~ 'Activity', labels, dataset, chartOptions) }}
        </div>
    </div>
{% endmacro %}

{#
    project         = Project
    project_view    = ProjectViewModel
    project_details = ProjectDetailsModel
#}
{% macro project_details(project, project_view, project_details, showMoneyBudget, showTimeBudget, view_revenue, see_users) %}
    {% set activities = project_details.activities %}
    {% set years = project_details.years %}
    {% import "macros/progressbar.html.twig" as progress %}
    {% import "macros/widgets.html.twig" as widgets %}
    {% import "macros/charts.html.twig" as charts %}
    {% set currency = project.customer.currency %}
    {% set chartPrefix = 'project' ~ project.id %}

    {%- set labels = [] %}
    {% set rates = [] %}
    {% set durations = [] %}
    {% for year in years %}
        {% set labels = labels|merge([year.year]) %}
        {% set rates = rates|merge([{'label': year.rate|money(currency), 'value': year.rate}]) %}
        {% set durations = durations|merge([{'label': year.duration|duration, 'value': year.duration|chart_duration}]) %}
    {% endfor -%}

    <div class="card mb-3">
        <div class="card-header">
            <h3 class="card-title">
                {{ widgets.label_project(project, {'inherit': false}) }}
            </h3>
            <div class="card-actions">
                {{ widgets.badge_counter(project_view.durationTotal|duration) }}
                {% if view_revenue %}
                    {{ widgets.badge_counter(project_view.rateTotal|money(currency)) }}
                {% endif %}
            </div>
        </div>
        <ul class="nav nav-tabs" data-bs-toggle="tabs">
            <li class="nav-item"><a class="nav-link active" href="#details-chart" data-bs-toggle="tab">{{ 'report_project_details'|trans({}, 'reporting') }}</a></li>
            {% if project_view.durationTotal > 0 %}
                <li class="nav-item"><a class="nav-link" data-chart="{{ chartPrefix }}Duration" href="#time-chart" data-bs-toggle="tab">{{ 'stats.workingTime'|trans }}</a></li>
            {% endif %}
            {% if view_revenue and project_view.rateTotal > 0 %}
                <li class="nav-item"><a class="nav-link" data-chart="{{ chartPrefix }}Rate" href="#revenue-chart" data-bs-toggle="tab">{{ 'stats.revenue'|trans }}</a></li>
            {% endif %}
            {% if see_users and project_details.userStats|length > 0 %}
                <li class="nav-item"><a class="nav-link" data-chart="{{ chartPrefix }}User" href="#user-chart" data-bs-toggle="tab">{{ 'label.user'|trans }}</a></li>
            {% endif %}
            {% if activities is not empty %}
                <li class="nav-item"><a class="nav-link" data-chart="{{ chartPrefix }}Activity" href="#activity-chart" data-bs-toggle="tab">{{ 'label.activity'|trans }}</a></li>
            {% endif %}
        </ul>
        <div class="tab-content mt-2 p-2">
            <div class="chart tab-pane active" id="details-chart">
                <div class="row">
                    <div class="col-xs-12 col-md-6">
                        <table class="table table-hover dataTable">
                            <tr {{ widgets.customer_row_attr(project.customer) }}>
                                <th class="w-min">
                                    {{ 'label.customer'|trans }}
                                </th>
                                <td>
                                    {{ widgets.label_customer(project.customer) }}
                                </td>
                            </tr>
                            <tr>
                                <th class="w-min">
                                    {{ 'stats.durationTotal'|trans }}
                                </th>
                                <td>{{ project_view.durationTotal|duration }}</td>
                            </tr>
                            {% if view_revenue %}
                            <tr>
                                <th class="w-min">
                                    {{ 'stats.amountTotal'|trans }}
                                </th>
                                <td>{{ project_view.rateTotal|money(currency) }}</td>
                            </tr>
                            {% endif %}
                        </table>
                    </div>
                    <div class="col-xs-12 col-md-6">
                        <table class="table table-hover dataTable">
                            <tr>
                                <th class="w-min">
                                    {{ 'label.last_record'|trans }}
                                </th>
                                <td>
                                    {% if project_view.lastRecord is not null %}
                                        {{ project_view.lastRecord|date_short }}
                                    {% else %}
                                        &ndash;
                                    {% endif %}
                                </td>
                            </tr>
                            {% if is_granted('create_export') %}
                            <tr>
                                <th class="w-min">
                                    {{ 'label.not_exported'|trans }}
                                </th>
                                <td>
                                    <a href="{{ path('export', {'customers[]': project.customer.id, 'projects[]': project.id, 'daterange': '', 'preview': true}) }}">
                                        {{ project_view.notExportedDuration|duration }}
                                    </a>
                                </td>
                            </tr>
                            {% endif %}
                            {% if is_granted('view_invoice') %}
                            <tr>
                                <th class="w-min">
                                    {{ 'label.not_invoiced'|trans }}
                                </th>
                                <td>
                                    <a href="{{ path('invoice', {'customers[]': project.customer.id, 'projects[]': project.id, 'daterange': ''}) }}">
                                        {{ project_view.notBilledRate|money(currency) }}
                                    </a>
                                </td>
                            </tr>
                            {% endif %}
                        </table>
                    </div>
                </div>
                {% if (showMoneyBudget and project.budget > 0) or (showTimeBudget and project.timeBudget > 0) %}
                    {% set budgetStats = project_details.budgetStatisticModel %}
                    <div class="row">
                        <div class="col-xs-12">
                            <table class="table table-hover dataTable">
                                {% if showTimeBudget and project.timeBudget > 0 %}
                                    <tr>
                                        <th class="w-min">
                                            {{ 'label.timeBudget'|trans }}
                                            {% if budgetStats.isMonthlyBudget() %}
                                                ({{ 'label.budgetType_month'|trans }})
                                            {% endif %}
                                        </th>
                                        <td>
                                            {{ progress.progressbar_timebudget(budgetStats) }}
                                        </td>
                                    </tr>
                                {% endif %}
                                {% if showMoneyBudget and project.budget > 0 %}
                                    <tr>
                                        <th class="w-min">
                                            {{ 'label.budget'|trans }}
                                            {% if budgetStats.isMonthlyBudget() %}
                                                ({{ 'label.budgetType_month'|trans }})
                                            {% endif %}
                                        </th>
                                        <td>
                                            {{ progress.progressbar_budget(budgetStats, project.customer.currency) }}
                                        </td>
                                    </tr>
                                {% endif %}
                            </table>
                        </div>
                    </div>
                {% endif %}

            </div>
            {% if view_revenue and project_view.rateTotal > 0 %}
            <div class="chart tab-pane" id="revenue-chart">
                {{ charts.bar_chart(chartPrefix ~ 'Rate', labels, [rates], {'height': '300px', 'renderEvent': 'render.' ~ chartPrefix ~ 'Rate'}) }}
            </div>
            {% endif %}
            {% if project_view.durationTotal > 0 %}
            <div class="chart tab-pane" id="time-chart">
                {{ charts.bar_chart(chartPrefix ~ 'Duration', labels, [durations], {'height': '300px', 'renderEvent': 'render.' ~ chartPrefix ~ 'Duration'}) }}
            </div>
            {% endif %}
            {% if activities is not empty %}
            <div class="chart tab-pane" id="activity-chart">
                {{ _self.activity_tab(activities, project_view.durationTotal, project.customer.currency, chartPrefix, view_revenue) }}
            </div>
            {% endif %}
            {% if see_users and project_details.userStats|length > 0 %}
            <div class="chart tab-pane" id="user-chart">
                <div class="row">
                    <div class="col-xs-12 col-sm-9 col-md-8 col-lg-6">
                        <table class="table table-hover dataTable">
                            {% set rateTotal = 0 %}
                            {% set totalDuration = 0 %}
                            {% set datasets = [] %}
                            {% set labels = [] %}
                            {% for userStat in project_details.userStats|sort((a, b) => b.duration <=> a.duration) %}
                                {% set user = userStat.user %}
                                {% set color = user.color|colorize(user.displayName) %}
                                {% set rateTotal = rateTotal + userStat.rate %}
                                {% set totalDuration = totalDuration + userStat.duration %}
                                {% set datasets = datasets|merge([{'name': user.displayName, 'duration': userStat.duration|duration, 'value': userStat.duration, 'color': color, 'rate': userStat.rate|money(currency)}]) %}
                                {% set percentage = 0 %}
                                {% if project_view.durationTotal > 0 and userStat.duration > 0 %}
                                    {% set percentage = (100 / (project_view.durationTotal / userStat.duration)) %}
                                {% endif %}
                                <tr>
                                    <td>
                                        {{ widgets.label_dot(user.displayName, user.color) }}
                                    </th>
                                    <td class="text-nowrap text-end">
                                        {{ userStat.duration|duration }}
                                    </td>
                                    {% if view_revenue %}
                                    <td class="text-nowrap text-end">
                                        {{ userStat.rate|money(currency) }}
                                    </td>
                                    {% endif %}
                                    <td class="text-nowrap text-end">
                                        {{ percentage|number_format(1) }} %
                                    </td>
                                </tr>
                            {% endfor %}
                                <tr>
                                    <td></td>
                                    <th class="text-nowrap text-end total">{{ totalDuration|duration }}</th>
                                    {% if view_revenue %}
                                    <th class="text-nowrap text-end total">{{ rateTotal|money(currency) }}</th>
                                    {% endif %}
                                    <td></td>
                                </tr>
                        </table>
                    </div>
                    <div class="col-xs-12 col-sm-3 col-md-4 col-lg-6">
                        {% set chartOptions = {'height': (datasets|length > 12 ? '600px' : '300px'), 'renderEvent': 'render.' ~ chartPrefix ~ 'User'} %}
                        {{ charts.doughnut_chart(chartPrefix ~ 'User', labels, datasets, chartOptions) }}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
{% endmacro %}
